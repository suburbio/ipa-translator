var MSQTA=MSQTA||{};MSQTA._IndexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;MSQTA._IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction;if(MSQTA._IDBTransaction&&(!MSQTA._IDBTransaction.READ_WRITE||!MSQTA._IDBTransaction.READ_ONLY)){MSQTA._IDBTransaction={READ_WRITE:"readwrite",READ_ONLY:"readonly"}}MSQTA._IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange;MSQTA._Errors={get:function(e,t){throw Error('MSQTA-ORM: get: missing search value on "'+t+'" schema from the "'+e+'" database!')},getByIndexWithRange1:function(e,t,n){throw Error('MSQTA-ORM: getByIndexWithRange: "'+n+'" is not an index in the "'+t+'" schema from the "'+e+'" database!')},getByIndexWithRange2:function(e){throw Error('MSQTA-ORM: getByIndexWithRange: operator "'+e+'" is not a valid one! You must use one of these: >, <, >=, <=, =')},getByIndexWithRange3:function(e,t,n,r){throw Error('MSQTA-ORM: getByIndexWithRange: comparator value "'+n+'" has been casted to a non-value:',r,' on "'+t+'" schema from the "'+e+'" database!')},getByIndexWithRange4:function(){throw Error("MSQTA-ORM: getByIndexWithRange: comparator data has an invalid set of comparision operators!")},getByIndexWithRange5:function(){throw Error("MSQTA-ORM: getByIndexWithRange: your range (>|>=) && (<|<=) is invalid!")},getByCallback:function(e,t){throw Error('MSQTA-ORM: getByCallback: missing callback function on "'+t+'" schema from the "'+e+'" database!')},getByIndex1:function(e,t,n){throw Error('MSQTA-ORM: getByIndex: "'+n+'" is not an index in the "'+t+'" schema from the "'+e+'" database!')},getByIndex2:function(e,t){throw Error('MSQTA-ORM: getByIndex: missing search value in "getByIndex" method from "'+t+'" schema from the "'+e+'" database!')},getWithLike1:function(){throw Error('MSQTA-ORM: getWithLike: like data is not valid, it must be something like this: "{type: "both", value: "john"}" !')},getWithLike2:function(e,t,n){throw Error('MSQTA-ORM: getWithLike: unknown "'+n+'" column on the "'+t+'" schema from the "'+e+'" database!')},put1:function(e,t,n){throw Error('MSQTA-ORM: put: "'+n+'" field refers to a non-existent field for the "'+t+'" schema from the "'+e+'" database!')},set1:function(e,t,n){throw Error('MSQTA-ORM: set: data param is invalid for the "'+t+'" schema from the "'+e+'" database!',n)},set2:function(e,t,n){throw Error('MSQTA-ORM: set: data to be set is invalid for the "'+t+'" schema from the "'+e+'" database!',n)},set3:function(e,t,n){throw Error('MSQTA-ORM: set: target data to be set is invalid for the "'+t+'" schema from the "'+e+'" database!',n)},set4:function(e,t,n,r,i){throw Error('MSQTA-ORM: set: comparator value "'+r+'" of the field "'+n+'" has been casted to a non-value:',r,' on "'+t+'" from the "'+e+'" database!')},set5:function(e,t,n,r,i){throw Error('MSQTA-ORM: set: new value "'+r+'" of the field "'+n+'" has been casted to a non-value:',i,' on "'+t+'" from the "'+e+'" database!')},del1:function(e,t){throw Error('MSQTA-ORM: del: schema "'+t+'" from the "'+e+'" database has not a primary key setted up!')},del2:function(e,t){throw Error('MSQTA-ORM: del: missing id(s) param to make the deletion in "'+t+'" schema from the "'+e+'" database!')},del3:function(e,t,n,r){throw Error('MSQTA-ORM: del: comparator value "'+n+'" has been casted to a non-value:',r,' on "'+t+'" from the "'+e+'" database!')},batch1:function(e,t){throw Error("MSQTA-ORM: batch: data param is invalid:",t,' on the "'+e+'" database!')},batch2:function(e){throw Error("MSQTA-ORM: batch: supplied Schema:",e," is not a instance of MSQTA")},batch3:function(e){throw Error('MSQTA-ORM: batch: type method "'+e+'" is incorrect, the valid ones are: put, set and del')}};MSQTA._Messages={"app is working":"The application is currently manipulating the database, please wait a moment, leaving the application right now will be cause that your database may get broken!"};MSQTA._Helpers={noop:function(){},defaultCallback:function(){console.log("MSQTA-ORM: default callback used");if(arguments[1]&&arguments[1].rows){var e=arguments[1].rows,t=0,n=e.length;for(;t<n;t++){console.log(e.item(t))}}else{console.log(arguments[0])}},blockWindow:function(){window.addEventListener("beforeunload",this.preLeaveWindow)},unblockWindow:function(){window.removeEventListener("beforeunload",this.preLeaveWindow)},preLeaveWindow:function(e){return e.returnValue=MSQTA._Messages["app is working"]},webSQLSize:2*1024*1024,getCaster:function(e){if(e==="object"||e==="array"){return this.castObj}if(e==="datetime"||e==="date"||e==="time"){return this.castDateTypeOf}if(e==="boolean"){return this.castBoolean}return this.castGeneric},castObj:function(e){return JSON.parse(e)},castDateTypeOf:function(e){var t=new Date(e);t.setMinutes(t.getMinutes()+t.getTimezoneOffset());return t},castBoolean:function(e){return!!e},castGeneric:function(e){return e},ormMethods:["batch","destroy"],schemaMethods:["del","destroy","empty","get","getAll","getWithLike","getByCallback","getByIndex","getByIndexWithRange","put","set"],dimSchemaInstance:function(e){var t=this.schemaMethods,n=this.noop,r,i;for(r=0,i=t.length;r<i;r++){e[t[r]]=n}},dimORMInstance:function(e){var t=this.ormMethods,n=this.schemaMethods,r,i,s,o=this.noop,u,a;for(u=0,a=t.length;u<a;u++){e[t[u]]=o}s=e._Schemas;for(r in s){i=s[r];for(u=0,a=n.length;u<a;u++){i[n[u]]=o}}},getORMPrototype:function(e){e=e.toLowerCase();if(e==="websql"){if(window.openDatabase){return MSQTA._ORM.WebSQL}}else if(e==="indexeddb"){if(MSQTA._IndexedDB){return MSQTA._ORM.IndexedDB}}if(window.openDatabase){return MSQTA._ORM.WebSQL}else if(MSQTA._IndexedDB){return MSQTA._ORM.IndexedDB}},instantiateSchema:function(e,t,n,r,i){var s={},o;if(!e){throw Error("MSQTA-ORM: Schema: missing new keyword at initializing a schema")}if(typeof i[1]==="function"){s.callback=i[1];s.context=i[2]||window}else if(typeof i[1]==="object"){s=i[1]}MSQTA._Schema.prototype=t;o=new MSQTA._Schema(e,n,s);o._resetSchemaAt=MSQTA._Helpers.resetSchemaAt;o._getValueBySchema=MSQTA._Helpers.getValueBySchema;o._implementation=r;o._init();return o},getValueBySchema:function(e,t){var n=this._schemaFields,r=this._name,i=n[e];if(!i){throw Error('MSQTA-ORM: unknown column "'+e+'" in the "'+r+'" schema!')}return i.sanitizer(t,i.zero)},supportedDataTypes:{string:"TEXT",integer:"INTEGER",object:"TEXT",array:"TEXT",date:"INTEGER",time:"INTEGER",datetime:"INTEGER","float":"REAL","boolean":"INTEGER"},webSQLZeros:{string:"",integer:0,object:"{}",array:"[]",date:-22090752e5,time:-22090752e5,datetime:-22090752e5,"float":0,"boolean":0},indexedDBZeros:{string:"","int":0,integer:0,text:"",object:{},array:[],date:-22090752e5,time:-22090752e5,datetime:-22090752e5,"float":0,"boolean":false},resetSchemaAt:function(e){var t=this._implementation,n=MSQTA._Helpers.supportedDataTypes,r=t==="webSQL"?MSQTA._Helpers.webSQLZeros:MSQTA._Helpers.indexedDBZeros,i=this._name,s=this._ORM._name,o=this._schemaFields[e],u,a=o.type,f=n[a],l=o.allowNull;if(!f){throw Error('MSQTA-ORM: column "'+e+'" with the data type "'+a+'" is invalid/not supported in the "'+i+'" schema from the "'+s+'" database!')}u=this._schemaFields[e];u.zero=l?null:r[a];u.sanitizer=t==="webSQL"?MSQTA._Helpers.WebSQLSanitizers.getSanitizer(a):MSQTA._Helpers.IndexedDBSanitizers.getSanitizer(a);u.isDate=a==="date"||a==="time"||a==="datetime";if(t==="webSQL"){u.abstract=a;u.real=f+(l?" NULL":"");u.isJSON=a==="object"||a==="array";u.toJS=MSQTA._Helpers.getCaster(a)}},tryJSONDate:function(e){return/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/.test(e)?new Date(e):false},tryMillisecondsDate:function(e){var t;e-=0;if(e){t=new Date(e);if(isNaN(t-0)){return false}return t}return false},resetTimeDate:function(e){e.setHours(0);e.setMinutes(0);e.setSeconds(0);e.setMilliseconds(0)},resetDateDate:function(e){e.setFullYear(0);e.setDate(0);e.setMonth(0)},getUTCDateInMilliseconds:function(e){return Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds(),0)},copyObject:function(e){return JSON.parse(JSON.stringify(e))}};MSQTA._Helpers.WebSQLSanitizers={getSanitizer:function(e){if(e==="string"||e==="text"){return this.sanitizeString}if(e==="int"||e==="integer"||e==="float"){return this.sanitizeInt}if(e==="object"||e==="array"){return this.sanitizeObj}if(e==="date"){return MSQTA._Helpers.IndexedDBSanitizers.sanitizeDate}if(e==="time"){return MSQTA._Helpers.IndexedDBSanitizers.sanitizeTime}if(e==="datetime"){return MSQTA._Helpers.IndexedDBSanitizers.sanitizeDatetime}if(e==="boolean"){return this.sanitizeBoolean}},sanitizeString:function(e,t){return e||t},sanitizeInt:function(e,t){e-=0;return!e?t:e},sanitizeObj:function(e,t){if(typeof e==="undefined"){return t}if(typeof e!=="object"){if(!e){return t}return e}try{return JSON.stringify(e)}catch(n){return t}},sanitizeBoolean:function(e,t){if(typeof e==="string"){e=e.toLowerCase();if(e==="true"||e==="1"){return 1}if(e==="false"||e==="0"){return 0}return t}if(e===1){return 1}if(e===0){return 0}return t},sanitizeGeneric:function(e){return e}};MSQTA._Helpers.IndexedDBSanitizers={getSanitizer:function(e){if(e==="string"||e==="text"){return this.sanitizeString}if(e==="int"||e==="integer"||e==="float"){return this.sanitizeInt}if(e==="object"||e==="array"){return this.sanitizeObj}if(e==="date"){return this.sanitizeDate}if(e==="time"){return this.sanitizeTime}if(e==="datetime"){return this.sanitizeDatetime}if(e==="boolean"){return this.sanitizeBoolean}},sanitizeString:function(e,t){return e?e+"":t},sanitizeInt:function(e,t){e-=0;return!e?t:e},sanitizeDate:function(e,t){var n,r;if(e instanceof Date){if(isNaN(e-0)){return t}MSQTA._Helpers.resetTimeDate(e);return MSQTA._Helpers.getUTCDateInMilliseconds(e)}if(r=MSQTA._Helpers.tryMillisecondsDate(e)){MSQTA._Helpers.resetTimeDate(r);return MSQTA._Helpers.getUTCDateInMilliseconds(r)}if(r=MSQTA._Helpers.tryJSONDate(e)){MSQTA._Helpers.resetTimeDate(r);return MSQTA._Helpers.getUTCDateInMilliseconds(r)}n=/^(\d{4}-\d{2}-\d{2})/.exec(e);if(!n){return t}n=n[1].split("-");return Date.UTC(n[0],n[1]-1,n[2],0,0,0,0)},sanitizeTime:function(e,t){var n,r;if(e instanceof Date){if(isNaN(e-0)){return t}MSQTA._Helpers.resetDateDate(e);return MSQTA._Helpers.getUTCDateInMilliseconds(e)}if(r=MSQTA._Helpers.tryMillisecondsDate(e)){MSQTA._Helpers.resetDateDate(r);return MSQTA._Helpers.getUTCDateInMilliseconds(r)}if(r=MSQTA._Helpers.tryJSONDate(e)){MSQTA._Helpers.resetDateDate(r);return MSQTA._Helpers.getUTCDateInMilliseconds(r)}n=/^(?:\d{4}-\d{2}-\d{2} )?(\d{2}):(\d{2})(?::(\d{2}))?$/.exec(e);if(!n){return t}return Date.UTC(0,0,0,n[1],n[2],n[3]||0,0)},sanitizeDatetime:function(e,t){var n,r;if(e instanceof Date){if(isNaN(e-0)){return t}MSQTA._Helpers.resetDateDate(e);return MSQTA._Helpers.getUTCDateInMilliseconds(e)}if(r=MSQTA._Helpers.tryMillisecondsDate(e)){return MSQTA._Helpers.getUTCDateInMilliseconds(r)}if(r=MSQTA._Helpers.tryJSONDate(e)){return MSQTA._Helpers.getUTCDateInMilliseconds(r)}n=/^(\d{4})-(\d{2})-(\d{2})(?:\s(\d{2}):(\d{2})(?::(\d{2}))?)?$/.exec(e);if(!n){return t}return Date.UTC(n[1],n[2]-1,n[3],n[4]||0,n[5]||0,n[6]||0,0)},sanitizeObj:function(e,t){if(typeof e==="undefined"){return t}if(typeof e!=="object"){if(!e){return t}if(typeof e==="string"){try{return JSON.parse(e)}catch(n){return t}}return e}return e},sanitizeBoolean:function(e,t){if(typeof e==="string"){e=e.toLowerCase();if(e==="true"||e==="1"){return true}if(e==="false"||e==="0"){return false}return t}if(e===1){return true}if(e===0){return false}return t},sanitizeGeneric:function(e){return e}};MSQTA.ORM=function(e,t,n){if(typeof e==="string"){e={name:e}}var r=e.name;if(!r){throw Error("MSQTA-ORM: not database name has been specify!")}if(r==="__msqta__"){throw Error("MSQTA-ORM: __msqta__ is a reserved word!")}if(!/^[\w][-.\w\d]+$/i.test(r)){throw Error("MSQTA-ORM: database name has invalid characters!")}e.callback=e.callback||t||MSQTA._Helpers.defaultCallback;e.context=e.context||n||window;MSQTA._ORM.prototype=MSQTA._Helpers.getORMPrototype(e.preferred||e.prefered||"");return new MSQTA._ORM(e)};MSQTA._ORM=function(e){var t=this._name=e.name;this.devMode=e.devMode||false;this._queries=[];this._Schemas={};this._batchsStack=[];this.Schema._ORM=this;this._isBlocked=true;this._schemasToInit=[];this._initCallback=e.callback;this._initContext=e.context;if(e.forceDestroy){if(this.devMode){console.log('MSQTA-ORM: "forceDestroy" flag detected for the "'+t+'" database, initializing process, tthen it will recreate again')}this._deleteUserDatabase(this._open,this)}else{this._open()}};MSQTA._Schema=function(e,t,n){var r=e._name,i=t.name;if(i==="__currents_ids__"){throw Error("MSQTA-ORM: __currents_ids__ is a reserved word!")}if(!/^[\w][-\w\d]+$/i.test(i)){throw Error("MSQTA-ORM: schema name has invalid characters!")}if(e._Schemas[i]&&!n.forceDestroy){throw Error('MSQTA-ORM: "'+i+'" schema already exists on the "'+r+'" database!')}var s=t.fields;if(typeof s!=="object"||!Object.keys(s).length){throw Error('MSQTA-ORM: "'+i+'" schema definition of the "'+r+'" database is invalid!')}var o=t.primaryKey;if(!o||o&&!s[o]){throw Error('MSQTA-ORM: primary key referes to a non-exisistent feld in the "'+i+'" schema from the "'+r+'" database!')}if(s[o].type!=="integer"){throw Error('MSQTA-ORM: primary key must be of integer type on "'+i+'" schema from the "'+r+'" database!')}s[o].allowNull=true;var u,a,f=[],l=[];for(u in s){a=s[u];if(a.index){if(!/^(integer|float|string|date|time|datetime|boolean)$/.test(a.type)){throw Error('MSQTA-ORM: index type must be of the type: integer|float|string|date|time|datetime, on "'+i+'" schema from the "'+r+'" database!')}f.push(u);a.index=true}else{a.index=false}if(a.unique){if(f.indexOf(u)===-1){f.push(u);a.index=true}l.push(u);a.unique=true}else{a.unique=false}}e._Schemas[i]=this;this._ORM=e;this.devMode=e.devMode;this._name=i;this._schemaFields=s;this._indexes=f;this._uniques=l;this._primaryKey=o;this._fieldsName=Object.keys(s);this._isForceDestroy=n.forceDestroy;this._isForceEmpty=this._isForceDestroy?false:n.forceEmpty;this._initCallback=n.callback||MSQTA._Helpers.defaultCallback;this._initContext=n.context||window};MSQTA._ORM.IndexedDB={Schema:function(e){return MSQTA._Helpers.instantiateSchema(this.constructor._ORM,MSQTA._Schema.IndexedDB,e,"indexedDB",arguments)},_SwapRecords:{init:function(e){var t=e.ORM,n=t._currentSchema,r=n._name;this.ORM=t;this.key=0;this.isAdvance=false;this.targetDB=null;this.baseDB=null;this.endCallback=e.endCallback;this.endContext=e.endContext;this.endArg=e.endArg;this.processCallback=e.processCallback;if(e.isBaseDBMSQTA){this.openBaseDB=this.openTestigoDB;this.baseSchema="dump";this.openTargetDB=this.openUserDB;this.targetSchema=r}else{this.openBaseDB=this.openUserDB;this.baseSchema=r;this.openTargetDB=this.openTestigoDB;this.targetSchema="dump"}this.getCursor()},openTestigoDB:function(){return this.ORM._openTestigoDatabase()},openUserDB:function(){return this.ORM._openUserDatabase()},getCursor:function(){var e=this,t=e.ORM,n=e.baseSchema,r=e.openBaseDB();r.onsuccess=function(t){e.baseDB=this.result;var r=e.baseDB.transaction([n],MSQTA._IDBTransaction.READ_ONLY),i=r.objectStore(n),s=i.openCursor();s._self=e;s.onsuccess=e.getRecord};r.onerror=t._initSchemaFail},getRecord:function(e){var t=this._self,n=t.baseDB,r=this.result;if(r){if(t.isAdvance){t.isAdvance=false;n.close();t.saveRecord(r.value)}else if(t.key===0){t.key++;n.close();t.saveRecord(r.value)}else{t.isAdvance=true;r.advance(t.key);t.key++}}else{n.close();t.done()}},saveRecord:function(e){var t=this,n=t.ORM,r=t.targetSchema,i=t.openTargetDB();i.onsuccess=function(n){t.targetDB=this.result;var i=t.targetDB.transaction([r],MSQTA._IDBTransaction.READ_WRITE),s=i.objectStore(r),o=t.processCallback(s,e,t.key);o._self=t;o.onsuccess=t.nextRecord;o.onerror=t.nextRecord};i.onerror=n._initSchemaFail},nextRecord:function(e){var t=this._self;t.targetDB.close();t.getCursor()},done:function(){this.endCallback.call(this.endContext,this.endArg)}},_open:function(){if(this.devMode){console.log('MSQTA-ORM: opening the testigo database "__msqta__"')}MSQTA._Helpers.blockWindow();var e=this,t=this._name,n=this._openTestigoDatabase();n.onupgradeneeded=function(t){var n=this.result,r;if(e.devMode){console.log('MSQTA-ORM: creating the schema for the testigo database "__msqta__" for the first time and never again')}r=n.createObjectStore("databases",{keyPath:"id",autoIncrement:true});r.createIndex("name","name",{unique:true});n.createObjectStore("dump")};n.onsuccess=function(n){var r=this.result,i=r.transaction(["databases"],MSQTA._IDBTransaction.READ_WRITE),s=i.objectStore("databases");s.index("name").get(t).onsuccess=function(n){var i=this.result;if(!i){if(e.devMode){console.log('MSQTA-ORM: database "'+t+'" is a new one, saving its metadata (branch and schema definition) in testigo "__msqta__" database')}e._currentBranch=0;s.add({name:t,branch:0,schemas:{}}).onsuccess=function(t){r.close();e._init()}}else{r.close();var o=i.branch;if(e.devMode){console.log('MSQTA-ORM: database "'+t+'" is already created, its current branch (version number) is: '+o)}e._currentBranch=o;e._init()}}};n.onerror=function(e){this._initCallback.call(this._initContext,null)}},_init:function(){if(this.devMode){console.log('MSQTA-ORM: "'+this._name+'" database has been created!')}MSQTA._Helpers.unblockWindow();this._initCallback.call(this._initContext,true);this._initSchemas()},_deleteUserDatabase:function(e,t){var n=this,r=this._name,i=MSQTA._IndexedDB.deleteDatabase(r);MSQTA._Helpers.blockWindow();i.onsuccess=function(s){i=n._openTestigoDatabase();i.onsuccess=function(i){var s=this.result,o=s.transaction(["databases"],MSQTA._IDBTransaction.READ_WRITE),u=o.objectStore("databases");u.index("name").get(r).onsuccess=function(r){var i=this.result;u.delete(i.id).onsuccess=function(r){s.close();MSQTA._Helpers.dimORMInstance(n);MSQTA._Helpers.unblockWindow();e.call(t||window,true)}}}};i.onerror=function(n){MSQTA._Helpers.unblockWindow();e.call(t||window,false)}},_initSchema:function(e){this._schemasToInit.push(e);if(!this._isBlocked){this._initSchemas()}},_initSchemas:function(){var e=this,t=this._name,n;if(this._schemasToInit.length){MSQTA._Helpers.blockWindow();n=this._openTestigoDatabase();n.onsuccess=function(n){var r=this.result,i=r.transaction(["databases"],MSQTA._IDBTransaction.READ_WRITE),s=i.objectStore("databases");s.index("name").get(t).onsuccess=function(t){var n=this.result;e._initSchemas2(r,s,n)}};n.onerror=this._initSchemaFail}else{this._endSchemasInitialization()}},_initSchemas2:function(e,t,n){var r=this,i=this._name,s=this._schemasToInit.shift(),o=s._name,u=n.schemas[o],a={fields:s._schemaFields,primaryKey:s._primaryKey};this._currentSchema=s;if(!u){this._updateUserDatabaseRecord(t,n);e.close();this._createSchema()}else if(s._isForceDestroy){if(this.devMode){console.log('MSQTA-ORM: "forceDestroy" flag detected: destroying the "'+o+'" schema from the database "'+i+'", then it will recreate again')}this._updateSchema3(this._updateSchema6)}else{if(this.devMode){console.log('MSQTA-ORM: checking for changes in the schema "'+o+'" schema from the database "'+i+'"')}e.close();if(this._checkSchemaChanges(u,a)){if(this.devMode){console.log("  new changes has been detected, proceeding to update its schema!")}if(s._isForceEmpty){if(this.devMode){console.log('  "forceEmpty" flag detected: emptying the "'+o+'" schema from the database "'+i+'", all records will be lost!')}this._updateSchema3(this._updateSchema6,this)}else{this._updateSchema()}}else{if(this.devMode){console.log(" no new changes has been detected!")}if(s._isForceEmpty){if(this.devMode){console.log('  "forceEmpty" flag detected: emptying the "'+o+'" schema from the database "'+i+'", all records will be lost!')}this._updateSchema7()}else{this._nextSchemaToInit()}}}},_checkSchemaChanges:function(e,t){var n=false,r,i=e.fields,s=t.fields,o,u;for(r in i){o=i[r];u=s[r];if(!u||o.type!==u.type||o.index!==u.index||o.unique!==u.unique){n=true;break}}var a=e.primaryKey,f=t.primaryKey;if(!n){if(a&&(!f||a!==f)||!a&&f){n=true}}return n},_updateUserDatabaseRecord:function(e,t){var n=this._currentSchema,r=n._name,i=n._primaryKey,s=n._schemaKeepTrack;t.schemas[r]={fields:s,primaryKey:i};req=e.put(t);return req},_createSchema:function(){var e=this,t=this._currentSchema,n=this._name,r=t._name,i=this._openUserDatabaseForChanges();i.onupgradeneeded=function(t){var i=this.result;if(e.devMode){console.log('MSQTA-ORM: proceeding to create the schema "'+r+'" for the "'+n+'" database')}e._createSchemaForReal(i)};i.onsuccess=function(t){var n=this.result;n.close();e._saveBranch(e._nextSchemaToInit,e)};i.onerror=this._initSchemaFail},_updateSchema:function(){var e=this,t=this._openTestigoDatabase();t.onsuccess=function(t){var n=this.result,r=n.transaction(["dump"],MSQTA._IDBTransaction.READ_WRITE),i=r.objectStore("dump");i.clear().onsuccess=function(t){n.close();e._updateSchema2()}};t.onerror=this._initSchemaFail},_updateSchema2:function(){var e=this,t=this._currentSchema,n=t._name;if(this.devMode){console.log("  (1) saving temporaly all records from the schema in the testigo database")}var r=function(e,t,n){return e.add(t,n)};this._SwapRecords.init({ORM:this,isBaseDBMSQTA:false,endCallback:this._updateSchema3,endContext:this,endArg:this._updateSchema4,processCallback:r})},_updateSchema3:function(e){var t=this,n=this._currentSchema,r=n._name,i=this._name,s=this._openUserDatabaseForChanges();s.onupgradeneeded=function(e){var n=this.result;if(t.devMode){console.log("  (2) re-creating schema, we need to drop it and create it again with the newly schema")}n.deleteObjectStore(r);t._createSchemaForReal(n)};s.onsuccess=function(n){var r=this.result;r.close();if(t.devMode){console.log("  (3) saving new branch of modified database")}t._saveBranch(e,t)};s.onerror=this._initSchemaFail},_updateSchema4:function(){var e=this,t=this._currentSchema,n=t._name,r=t._schemaFields;if(this.devMode){console.log("  (4) restoring and recasting the saved temporaly records (if there any) to the recenlty updated schema")}var i=function(t,n){var i,s;for(s in n){i=r[s];if(i){n[s]=i.sanitizer(n[s],i.zero)}else{delete n[s]}}if(e.devMode){console.log(n)}return t.put(n)};this._SwapRecords.init({ORM:this,isBaseDBMSQTA:true,endCallback:this._updateSchema5,endContext:this,processCallback:i})},_updateSchema5:function(){var e=this,t=this._name,n;n=this._openTestigoDatabase();n.onsuccess=function(t){var n=this.result,r=n.transaction(["dump"],MSQTA._IDBTransaction.READ_WRITE),i=r.objectStore("dump");if(e.devMode){console.log("  (5) deleting the temporaly saved records")}i.clear().onsuccess=function(t){n.close();e._updateSchema6()}};n.onerror=this._initSchemaFail},_updateSchema6:function(){var e=this,t=this._name,n=this._currentSchema,r=n._name,i;i=this._openTestigoDatabase();i.onsuccess=function(n){var r=this.result,i=r.transaction(["databases"],MSQTA._IDBTransaction.READ_WRITE),s=i.objectStore("databases");s.index("name").get(t).onsuccess=function(t){var n=this.result,i;if(e.devMode){console.log(" (6) update schema information on testigo database to keep tracking future changes")}i=e._updateUserDatabaseRecord(s,n);i.onsuccess=function(t){r.close();e._updateSchema8()}}};i.onerror=this._initSchemaFail},_updateSchema7:function(){var e=this,t=this._name,n=this._currentSchema,r=n._name,i;i=this._openUserDatabase();i.onsuccess=function(t){var n=this.result,i=n.transaction([r],MSQTA._IDBTransaction.READ_WRITE),s=i.objectStore(r);s.clear().onsuccess=function(t){e._updateSchema8()}};i.onerror=this._initSchemaFail},_updateSchema8:function(){if(this.devMode){console.log("  (7) update schema process is done")}this._nextSchemaToInit()},_initSchemaFail:function(){this._nextSchemaToInit(false)},_createSchemaForReal:function(e){var t=this._currentSchema,n=t._schemaFields,r=t._name,i=t._primaryKey,s,o,u,a;if(this.devMode){console.log(" primary key: "+i)}a=e.createObjectStore(r,{keyPath:i,autoIncrement:true});for(s in n){o=n[s];if(o.index){u=o.unique;if(this.devMode){console.log("  index: "+s+(u?" (unique)":""))}a.createIndex(s,s,u?{unique:true}:{})}}},_nextSchemaToInit:function(e){var t=this._currentSchema,n=t._initCallback,r=t._initContext;n.call(r,typeof e==="undefined"?true:e);delete t._initCallback;delete t._initContext;delete t._isForceDestroy;delete t._isForceEmpty;delete this._currentSchema;MSQTA._Helpers.unblockWindow();this._initSchemas()},_endSchemasInitialization:function(){this._isBlocked=false},_saveBranch:function(e,t){var n=this,r=this._name,i=this._currentBranch,s;s=this._openTestigoDatabase();s.onsuccess=function(s){var o=this.result,u=o.transaction(["databases"],MSQTA._IDBTransaction.READ_WRITE),a=u.objectStore("databases");a.index("name").get(r).onsuccess=function(s){var u=this.result;if(n.devMode){console.log('MSQTA-ORM: saving branch (version number) from the database "'+r+'" to: '+i)}u.branch=i;a.put(u);o.close();if(e){e.call(t||window)}}}},_openUserDatabaseForChanges:function(){var e=this._name,t=this._currentBranch+1;if(this.devMode){console.log('MSQTA-ORM: opening "'+e+'" at branch: '+t+" to make schema changes")}this._currentBranch=t;return MSQTA._IndexedDB.open(e,t)},_openUserDatabase:function(){var e=this._name,t=this._currentBranch;if(this.devMode){console.log('MSQTA-ORM: opening "'+e+'" at branch: '+t)}return MSQTA._IndexedDB.open(e,t)},_openTestigoDatabase:function(){return MSQTA._IndexedDB.open("__msqta__",1)},_preExec:function(e){if(!e.userCallback){e.userCallback=MSQTA._Helpers.defaultCallback}if(!e.userContext){e.userContext=window}this._queries.push(e);if(this._isWaiting){return}this._isWaiting=true;MSQTA._Helpers.blockWindow();this._exec()},_exec:function(){var e=this._queries.shift();if(e.type==="destroy"){this._destroy(e)}else{this._getSchemaObjectStore(e,this._exec2,this)}},_exec2:function(e){var t=e.schema,n=e.type;if(this.devMode){console.log('MSQTA-ORM: "'+t+'" schema will be manipulate ('+n+") with the data (may be undefined):",e.data)}this["_"+n](e)},_getSchemaObjectStore:function(e,t,n){var r=e.schema,i=this._openUserDatabase();i.onsuccess=function(i){var s=this.result,o=s.transaction([r],MSQTA._IDBTransaction[e.isReadOnly?"READ_ONLY":"READ_WRITE"]),u=o.objectStore(r);e.activeObjectStore=u;e.activeDatabase=s;t.call(n,e)}},_continue:function(){this._isWaiting=false;if(this._queries.length){this._exec()}},_done:function(e,t,n){MSQTA._Helpers.unblockWindow();e.activeDatabase.close();e.userCallback.call(e.userContext,t,n);this._continue()},_put:function(e){var t=this,n=e.activeObjectStore,r=e.data,i=0,s=[],o=r.length;var u=function(n){if(n){s.push(n)}if(i===o){t._done(e,n,s)}else{f();i++}};var a=function(){t._done(e,false)};var f=function(){var e=r[i],t=n.add(e);t.onsuccess=function(e){u(this.result)};t.onerror=function(e){a()}};u()},_set:function(e){var t=this,n=e.activeObjectStore,r=e.data,i=e.indexes,s=e.primaryKey,o=0,u=0,a=r.length;var f=function(){if(u===a){t._done(e,o)}else{c();u++}};var l=function(){t._done(e,false)};var c=function(){var e=r[u],t=e.data,i=e.target,a=i[s],c,h=Object.keys(i).length;if(a){n.get(a).onsuccess=function(e){var r=this.result,i;if(r){for(c in t){r[c]=t[c]}i=n.put(r);i.onsuccess=function(e){if(this.result){o++}f()};i.onerror=function(e){l()}}else{f()}}}else{n.openCursor().onsuccess=function(e){var n=this.result;if(n){var r=n.value,s=0,u;for(c in i){if(r[c]===i[c]){s++}}if(s===h){for(c in t){r[c]=t[c]}u=n.update(r);u.onsuccess=function(e){if(this.result){o++}n.continue()};u.onerror=function(e){l()}}else{n.continue()}}else{f()}}}};f()},_del:function(e){var t=this,n=e.activeObjectStore;n.count().onsuccess=function(n){e.recordsAffected=this.result;t._del2(e)}},_del2:function(e){var t=this,n=e.data,r=e.primaryKey,i=e.activeObjectStore,s=0,o=n.length;var u=function(){if(s===o){t._del3(e)}else{a();s++}};var a=function(){var e=n[s];i.delete(e[r]).onsuccess=function(e){u()}};u()},_del3:function(e){var t=this,n=e.activeObjectStore;n.count().onsuccess=function(n){t._done(e,e.recordsAffected-this.result)}},_empty:function(e){var t=this,n,r=e.activeObjectStore;r.count().onsuccess=function(i){n=this.result;r.clear().onsuccess=function(r){t._done(e,n)}}},_destroy:function(e){var t=this,n=e.schema,r=this._openUserDatabaseForChanges();r.onupgradeneeded=function(e){var t=this.result;t.deleteObjectStore(n)};r.onsuccess=function(n){var r=this.result;r.close();t._destroy2(e)}},_destroy2:function(e){var t=this,n=this._name,r=e.schema,i=this._Schemas[r],s=this._openTestigoDatabase();s.onsuccess=function(s){var o=this.result,u=o.transaction(["databases"],MSQTA._IDBTransaction.READ_WRITE),a=u.objectStore("databases");a.index("name").get(n).onsuccess=function(n){var s=this.result;delete s.schemas[r];a.put(s).onsuccess=function(n){t._saveBranch(function(){e.activeDatabase=o;delete t._Schemas[r];MSQTA._Helpers.dimSchemaInstance(i);this._done(e,true)},t)}}}},_getAll:function(e){var t=this,n=e.schema,r=e.filterCallback,i=e.filterFields,s=e.filterComparator,o=e.activeObjectStore,u=[];o.openCursor().onsuccess=function(o){var a=this.result,f;if(a){f=a.value;if(r(f,i,s)){t._checkDateTypeFields(n,f);u.push(f)}a.continue()}else{t._done(e,u)}}},_getWithRange:function(e){var t=this,n=e.schema,r=e.rangePk,i=e.rangeIndex,s=e.rangeKey,o=e.activeObjectStore,u=[];var a=function(r){var i=this.result,s;if(i){s=i.value;t._checkDateTypeFields(n,s);u.push(s);i.continue()}else{t._done(e,u)}};if(r){o.openCursor(s).onsuccess=a}else{o.index(i).openCursor(s).onsuccess=a}},_checkDateTypeFields:function(e,t){var n=this._Schemas[e],r=n._schemaFields,i;for(i in t){if(r[i].isDate){t[i]=MSQTA._Helpers.castDateTypeOf(t[i])}}},batch:function(e,t,n){var r=this._name,i;if(!Array.isArray(e)||!e.length){MSQTA._Errors.batch1(r,e)}if(typeof t!=="function"){t=MSQTA._Helpers.defaultCallback}if(typeof n!=="object"){n=window}i={data:e,userCallback:t,userContext:n};if(this._isBatchMode){this._batchsStack.push(i);return}this._isBatchMode=true;this._batch(i)},_batch:function(e){var t=e.data,n=["set","put","del"],r=0,i=t.length,s,o,u,a;for(;r<i;r++){o=t[r],u=o.schema;if(!(u instanceof MSQTA._Schema)){MSQTA._Errors.batch2(u)}a=o.type.toLowerCase();if(n.indexOf(a)===-1){MSQTA._Errors.batch3(a)}s=u[a](o.data);s.userCallback=MSQTA._Helpers.defaultCallback;s.userContext=window;this._queries.push(s)}s=this._queries[this._queries.length-1];s.userCallback=e.userCallback;s.userContext=e.userContext;this._isBatchMode=false;if(!this._isWaiting){this._continue()}},destroy:function(e,t){this._deleteUserDatabase(e||MSQTA._Helpers.noop,t)}};MSQTA._Schema.IndexedDB={_init:function(){var e=this._ORM,t=this._schemaFields,n,r,i={};for(n in t){r=t[n];this._resetSchemaAt(n);i[n]={type:r.type,index:r.index,unique:r.unique}}this._schemaKeepTrack=i;e._initSchema(this)},get:function(e,t,n){var r=this._ORM,i=r._name,s=this._schemaFields,o,u={},a=this._name,f;if(!e){MSQTA._Errors.get(i,a)}for(o in s){u[o]=this._getValueBySchema(o,e)}var l=function(e,t,n){for(var r in e){if(e[r]===n[r]){return true}}return false};if(this.devMode){console.log('MSQTA-ORM: fetching record(s) from "'+a+'" schema from the "'+i+'" database')}f={type:"getAll",isReadOnly:true,schema:a,filterCallback:l,filterComparator:u,userCallback:t,userContext:n};r._preExec(f)},getAll:function(e,t){var n=this._ORM,r=n._name,i=this._name,s;var o=function(){return true};if(this.devMode){console.log('MSQTA-ORM: fetching all records from "'+i+'" schema from the "'+r+'" database')}s={type:"getAll",isReadOnly:true,schema:i,filterCallback:o,userCallback:e,userContext:t};n._preExec(s)},getWithLike:function(e,t,n,r){var i=this._ORM,s=i._name,o=this._schemaFields,u=this._name,a,f,l,c,h,p;if(typeof t!=="object"){MSQTA._Errors.getWithLike1()}c=Object.keys(t)[0];h=t[c];if(!c||!h){MSQTA._Errors.getWithLike1()}if(c==="both"){h=new RegExp(h,"i")}else if(c==="start"){h=new RegExp("^"+h,"i")}else if(c==="end"){h=new RegExp(h+"$","i")}if(!Array.isArray(e)){e=[e]}for(a=0,f=e.length;a<f;a++){l=e[a];if(!o[l]){MSQTA._Errors.getWithLike2(s,u,l)}}var d=function(e,t,n){var r,i=0,s=t.length;for(;i<s;i++){r=t[i];if(n.test(e[r])){return true}}return false};if(this.devMode){console.log('MSQTA-ORM: fetching record(s) from "'+u+'" schema from the "'+s+'" database with like')}p={type:"getAll",isReadOnly:true,schema:u,filterCallback:d,filterComparator:h,filterFields:e,userCallback:n,userContext:r};i._preExec(p)},getByCallback:function(e,t,n){var r=this._ORM,i=r._name,s=this._name,o;if(typeof e!=="function"){MSQTA._Errors.getByCallback(i,s)}if(this.devMode){console.log('MSQTA-ORM: fetching record(s) from "'+s+'" schema from the "'+i+'" database by "callback"')}o={type:"getAll",isReadOnly:true,schema:s,filterCallback:e,userCallback:t,userContext:n};r._preExec(o)},getByIndex:function(e,t,n,r){var i=this._ORM,s=i._name,o=this._name,u={},a=[],f,l,c,h,p,d;if(this._primaryKey!==e){if(this._indexes.indexOf(e)===-1){MSQTA._Errors.getByIndex1(s,o,e)}}if(this._primaryKey===e){u.pk=e}else{u.index=e}if(!t){MSQTA._Errors.getByIndex2(s,o)}if(!Array.isArray(t)){t=[t]}if(this.devMode){console.log('MSQTA-ORM: fetching record(s) from "'+o+'" schema from the "'+s+'" database using '+(u.pk?'primary key: "'+u.pk+'"':'index: "'+u.index+'"'))}if(t.length===1){d={type:"getWithRange",isReadOnly:true,schema:o,rangePk:u.pk,rangeIndex:u.index,rangeKey:MSQTA._IDBKeyRange.only(this._getValueBySchema(e,t[0])),userCallback:n,userContext:r}}else{for(h=0,p=t.length;h<p;h++){l=t[h];c=this._getValueBySchema(e,l);a.push(c)}f=function(e,t,n){for(var r=0,i=t.length;r<i;r++){if(t[r]===e[n]){return true}}return false};d={type:"getAll",isReadOnly:true,schema:o,filterCallback:f,filterComparator:u.pk||u.index,filterFields:a,userCallback:n,userContext:r}}i._preExec(d)},getByIndexWithRange:function(e,t,n,r){var i=this._ORM,s=i._name,o=this._name,u=this._schemaFields,a=/^(?:>|<|>=|<=|=)$/,f,l={},c={},h,p,d=u[e],v,m,g;if(this._primaryKey!==e){if(this._indexes.indexOf(e)===-1){MSQTA._Errors.getByIndexWithRange1(s,o,e)}}if(this._primaryKey===e){l.pk=e}else{l.index=e}for(f in t){if(!a.test(f)){MSQTA._Errors.getByIndexWithRange2(f)}v=t[f];m=this._getValueBySchema(e,v);if(!m&&m!==d.zero){MSQTA._Errors.getByIndexWithRange3(s,o,v,m)}c[f]=m}h=Object.keys(c).length;if(h===2){try{if(c[">"]&&c["<"]){p=MSQTA._IDBKeyRange.bound(c[">"],c["<"],true,true)}else if(c[">="]&&c["<="]){p=MSQTA._IDBKeyRange.bound(c[">="],c["<="])}else if(c[">"]&&c["<="]){p=MSQTA._IDBKeyRange.bound(c[">"],c["<="],true,false)}else{p=MSQTA._IDBKeyRange.bound(c[">="],c["<"],false,true)}}catch(y){MSQTA._Errors.getByIndexWithRange5()}}else if(h===1){if(c[">"]){p=MSQTA._IDBKeyRange.lowerBound(c[">"],true)}else if(c[">="]){p=MSQTA._IDBKeyRange.lowerBound(c[">="])}else if(c["<"]){p=MSQTA._IDBKeyRange.upperBound(c["<"],true)}else if(c["<="]){p=MSQTA._IDBKeyRange.upperBound(c["<="])}else{p=MSQTA._IDBKeyRange.only(c["="])}}if(!p){MSQTA._Errors.getByIndexWithRange4()}l.keyRange=p;if(this.devMode){console.log('MSQTA-ORM: fetching record(s) from "'+o+'" schema from the "'+s+'" database using '+(l.pk?'primary key: "'+l.pk+'"':'index: "'+l.index+'"')+" with range")}g={type:"getWithRange",isReadOnly:true,schema:o,rangePk:l.pk,rangeIndex:l.index,rangeKey:p,userCallback:n,userContext:r};i._preExec(g)},put:function(e,t,n){var r=this._ORM,i=r._name,s=this._fieldsName,o,u,a=this._primaryKey,f=this._name,l,c,h,p;if(!Array.isArray(e)&&typeof e==="object"){e=[e]}e=MSQTA._Helpers.copyObject(e);for(c=0,h=e.length;c<h;c++){l=e[c];for(o in l){if(s.indexOf(o)===-1){MSQTA._Errors.put1(i,f,o)}l[o]=this._getValueBySchema(o,l[o])}if(l[a]<=0){delete l[a]}}p={type:"put",schema:f,primaryKey:a,data:e,userCallback:t,userContext:n};if(r._isBatchMode){return p}r._preExec(p)},set:function(e,t,n){var r=this._ORM,i=this._name,s=this._schemaFields,o=r._name,u,a,f,l,c,h,p,d={},v={},m=[],g,y,b;if(!e||typeof e!=="object"){MSQTA._Errors.set1(o,i,e)}if(!Array.isArray(e)){e=[e]}e=MSQTA._Helpers.copyObject(e);for(g=0,y=e.length;g<y;g++){a=e[g];if(!a.data||typeof a.data!=="object"||!Object.keys(a.data).length){MSQTA._Errors.set2(o,i,a.data)}if(a.target){if(typeof a.target!=="object"||!Object.keys(a.target).length){MSQTA._Errors.set3(o,i,a.target)}}else{a.target=[]}l=a.target;for(h in l){p=l[h];f=this._getValueBySchema(h,p);if(!f&&f!==s[h].zero){MSQTA._Errors.set4(o,i,h,p,f)}d[h]=f}c=a.data;for(h in c){p=c[h];f=this._getValueBySchema(h,p);if(!f&&f!==s[h].zero){MSQTA._Errors.set5(o,i,h,p,f)}v[h]=f}m.push({data:v,target:d});v={};d={}}b={type:"set",schema:i,indexes:this._indexes,primaryKey:this._primaryKey,data:m,userCallback:t,userContext:n};if(r._isBatchMode){return b}r._preExec(b)},del:function(e,t,n){var r=this._ORM,i=r._name,s=this._primaryKey,o=this._name,u,a,f,l=[],c,h,p;if(!s){MSQTA._Errors.del1(i,o)}if(!e){MSQTA._Errors.del2(i,o)}if(!Array.isArray(e)){e=[e]}for(c=0,h=e.length;c<h;c++){u=e[c];a=this._getValueBySchema(s,u);if(!a){MSQTA._Errors.del3(i,o,u,a)}f={};f[s]=a;l.push(f)}p={type:"del",schema:o,primaryKey:s,data:l,userCallback:t,userContext:n};if(r._isBatchMode){return p}r._preExec(p)},destroy:function(e,t){var n=this._ORM,r=n._name,i=this._name;if(this.devMode){console.log('MSQTA-ORM: destroying "'+i+'" from the "'+r+'" database')}n._preExec({type:"destroy",schema:i,userCallback:e,userContext:t})},empty:function(e,t){var n=this._ORM,r=n._name,i=this._name;if(this.devMode){console.log('MSQTA-ORM: emptying "'+i+'" from the "'+r+'" database')}n._preExec({type:"empty",schema:i,userCallback:e,userContext:t})}};MSQTA._ORM.WebSQL={Schema:function(e){return MSQTA._Helpers.instantiateSchema(this.constructor._ORM,MSQTA._Schema.WebSQL,e,"webSQL",arguments)},_open:function(){(function(e){MSQTA._Helpers.blockWindow();e._testigoDB=window.openDatabase("__msqta__",1,"",MSQTA._Helpers.webSQLSize);e._testigoDB.transaction(function(t){if(e.devMode){console.log('MSQTA.ORM: creating if not exists (first run) the table "databases" on "__msqta__" internal database')}t.executeSql("CREATE TABLE IF NOT EXISTS databases( id INTEGER PRIMARY KEY, name TEXT UNIQUE, schemas TEXT )");t.executeSql('SELECT * FROM databases WHERE name = "'+e._name+'"',[],function(t,n){e._open2(n)})})})(this)},_open2:function(e){var t=e.rows;this._schemasDefinition=t.length?JSON.parse(t.item(0).schemas):{};this._queriesInternal=[];if(this.devMode){console.log('MSQTA.ORM: creating/opening the "'+this._name+'" user database')}this._userDB=window.openDatabase(this._name,1,"",MSQTA._Helpers.webSQLSize);(function(e){e._userDB.transaction(function(t){if(e.devMode){console.log('MSQTA.ORM: creating if not exists (first run) the table __currents_ids__ on "'+e._name+'" user database')}t.executeSql("CREATE TABLE IF NOT EXISTS __currents_ids__( id INTEGER PRIMARY KEY, table_name TEXT UNIQUE, last_id INTEGER )")},null,function(){MSQTA._Helpers.unblockWindow();e._initCallback.call(e.initContext,true);e._initSchemas()})})(this)},_initSchema:function(e){this._schemasToInit.push(e);if(!this._isBlocked){this._isBlocked=true;this._initSchemas()}},_initSchemas:function(){var e=this,t,n=this._name;if(this._schemasToInit.length){MSQTA._Helpers.blockWindow();t=this._schemasToInit.shift();t._init2()}else{MSQTA._Helpers.unblockWindow();this._endSchemasInitialization()}},_endSchemasInitialization:function(){this._isBlocked=false},_saveSchemaOnTestigoDatabase:function(e,t,n){var r=this,i=this._name,s=this._schemasDefinition;if(this.devMode){console.log("MSQTA-ORM: saving schema definition in the testigo database to keep tracking future changes on it")}this._testigoDB.transaction(function(e){e.executeSql('REPLACE INTO databases( name, schemas ) VALUES( "'+i+'", '+"'"+JSON.stringify(s)+"'"+")")},null,function(){e.call(t,n)})},_deleteUserDatabase:function(e,t){this.destroy(e,t)},_deleteUserSchema:function(e,t){var n=this,r=e._name;delete this._Schemas[r];delete this._schemasDefinition[r];MSQTA._Helpers.dimSchemaInstance(e);this._userDB.transaction(function(e){if(n.devMode){console.log('MSQTA-ORM: stop tracking "last inserted id" from this schema')}e.executeSql('DELETE FROM __currents_ids__ WHERE table_name = "'+r+'"')},null,function(){n._saveSchemaOnTestigoDatabase(t.userCallback,t.userContext,true)})},_error:function(e){console.error("MSQTA-ORM: query has failed: \n "+"code: "+e.code+"\n "+"message: "+e.message)},_transaction:function(e){var t=e.userCallback,n=e.userContext;if(!t){e.userCallback=MSQTA._Helpers.defaultCallback}if(!n){e.userContext=window}if(this._isWaiting){if(e.isInternal){this._queriesInternal.push(e)}else{this._queries.push(e)}return}this._isWaiting=true;MSQTA._Helpers.blockWindow();this._transaction2(e)},_transaction2:function(e){this._lastQuery=e;var t=this,n=0,r=[],i=e.query;if(!Array.isArray(i)){i=[i]}var s=e.isUpdate?function(e,t){n+=t.rowsAffected}:e.isInsert?function(e,t){r.push(t.insertId)}:MSQTA._Helpers.noop;var o=function(i,s){if(e.isUpdate){e.returnValue=s.rowsAffected+n}else if(e.isInsert){e.returnValue=s.insertId;if(!r.length){r.push(s.insertId)}e.insertedIDs=r}else if(e.isDelete){e.returnValue=s.rowsAffected}t._results(s)};var u=function(e){t._error(e);t._results(false)};this._userDB.transaction(function(n){var r,u=i.length;while(u--){r=i.shift();if(t.devMode){console.log("MSQTA-ORM: executing the query: \n "+r)}n.executeSql(r,e.replacements?e.replacements.shift():[],u?s:o)}},u)},_results:function(e){var t=this._lastQuery;this._isWaiting=false;if(!e){t.returnValue=false}if(t.internalCallback){t.internalCallback.call(t.internalContext,e,t)}else{t.userCallback.call(t.userContext,t.returnValue,t.insertedIDs)}this._continue()},_continue:function(){MSQTA._Helpers.unblockWindow();if(!this._isWaiting){if(this._queriesInternal.length){this._transaction(this._queriesInternal.shift())}else if(this._queries.length&&!this._isBlocked){this._transaction(this._queries.shift())}}},batch:function(e,t,n){var r=this._name,i;if(!Array.isArray(e)||!e.length){MSQTA._Errors.batch1(r,e)}if(!t){t=MSQTA._Helpers.defaultCallback}if(!n){n=window}i={data:e,callback:t,context:n};if(this._isBatchMode){this._batchsStack.push(i);return}this._isBatchMode=true;this._batch(i)},_batch:function(e){var t=e.data,n=["set","put","del"],r,i,s,o=0,u=t.length;for(;o<u;o++){r=t[o];i=r.schema;if(!(i instanceof MSQTA._Schema)){MSQTA._Errors.batch2(i)}s=r.type.toLowerCase();if(n.indexOf(s)===-1){MSQTA._Errors.batch3(s)}this._queries.push(i[s](r.data))}var a=this._queries[this._queries.length-1];a.userCallback=e.callback;a.userContext=e.context;this._isBatchMode=false;this._continue();if(this._batchsStack.length){this._batch(this._batchsStack.shift())}},destroy:function(e,t){console.error("MSQTA: destroy: deleting a database is not implemented in webSQL standard and will never do.\n To delete a database you need to do manually.");(e||MSQTA._Helpers.noop).call(t||window,false)}};MSQTA._Schema.WebSQL={_init:function(){var e=this._schemaFields,t,n,r=this._ORM,i=r._name,s=this._name,o=[],u=this._primaryKey,a,f={},l,c,h={};for(n in e){t=e[n];a=[];if(u===n){a.push("PRIMARY KEY")}else{l=t.index;c=t.unique;if(l&&c){f[n]=true}else if(l){f[n]=false}}this._resetSchemaAt(n);h[n]={type:t.type,index:t.index,unique:t.unique};o.push(n+" "+e[n].real+(a.length?" "+a.join(" "):""))}this._createTableQuery='CREATE TABLE "'+s+'" ( '+o.join(", ")+" )";this._schemaKeepTrack=h;this._indexesToCreate=f;this._indexesToDelete=[];r._initSchema(this)},_init2:function(){var e=this._ORM,t=e._name,n=this._name,r,i,s;if(this._isForceDestroy){r='--MSQTA-ORM: "forceDestroy" flag detected: destroying the "'+n+'" schema from the "'+t+'" database, then it will recreate again--\n  DROP TABLE IF EXISTS '+n;e._transaction({query:r,internalContext:this,internalCallback:this._createSchema,isInternal:true})}else{if(this.devMode){console.log('MSQTA.ORM: checking for schema changes in "'+n+'" from the "'+t+'" datatabase')}s={fields:this._schemaKeepTrack,primaryKey:this._primaryKey};i=e._schemasDefinition[n];if(!i){e._schemasDefinition[n]=s;this._ORM._saveSchemaOnTestigoDatabase(this._createSchema,this)}else{this._checkSchemaChanges(i,s)}}},_getIndexUniqueQuery:function(e,t,n){return"CREATE UNIQUE INDEX "+this._getIndexName(e,t)+" ON "+(n||e)+" ( "+t+" )"},_getIndexQuery:function(e,t,n){return"CREATE INDEX "+this._getIndexName(e,t)+" ON "+(n||e)+" ( "+t+" )"},_getIndexName:function(e,t){return e+"_"+t},_checkSchemaChanges:function(e,t){var n=this._ORM,r=n._name,i=this._name,s=false,o=e.fields,u=t.fields,a,f,l;for(l in o){a=o[l];f=u[l];if(!f||a.type!==f.type||a.unique!==f.unique){s=true;break}}var c=e.primaryKey,h=t.primaryKey;if(!s){if(c&&(!h||c!==h)||!c&&h){s=true}}if(s){if(this.devMode){console.log(" specified schema differs to the registered one, starting update process!")}n._schemasDefinition[i]=t;this._ORM._saveSchemaOnTestigoDatabase(this._updateSchema,this)}else{var p=[],d=this._indexes,v=this._indexesToCreate;for(l in o){a=o[l];if(a.index){if(d.indexOf(l)===-1){p.push(l)}else{delete v[l]}}}if(p.length||Object.keys(v).length){this._indexesToDelete=p;if(this.devMode){console.log(" schema is still the same, but its index(s) has been changed, starting updating indexes process!")}n._schemasDefinition[i]=t;this._ORM._saveSchemaOnTestigoDatabase(this._updateSchema10,this)}else{if(this.devMode){console.log(" no changes detected on its schema nor its index(s)!")}if(this._isForceEmpty){this._updateSchema9()}else{this._updateSchema8()}}}},_createSchema:function(){var e=this._ORM,t=this._name,n=e._name,r=this._primaryKey,i,s;if(this.devMode){console.log(" the schema is a new one, starting creation process!");console.log('   1) Creating the "'+t+'" table and its "last_id" trigger')}i="CREATE TRIGGER IF NOT EXISTS update_last_id_on_"+t+" AFTER INSERT ON "+t+" BEGIN "+" UPDATE __currents_ids__ SET last_id = ( "+" SELECT CASE "+' WHEN ( SELECT 1 WHERE NEW.rowid >= ( SELECT last_id FROM __currents_ids__ WHERE table_name = "'+t+'" ) )'+" THEN NEW.rowid "+' WHEN ( SELECT 1 WHERE NEW.rowid < ( SELECT last_id FROM __currents_ids__ WHERE table_name = "'+t+'" ) )'+' THEN ( SELECT last_id - 1 FROM __currents_ids__ WHERE table_name = "'+t+'" ) '+" ELSE "+' ( SELECT last_id FROM __currents_ids__ WHERE table_name = "'+t+'" ) '+" END "+' ) + 1 WHERE table_name = "'+t+'" ; '+" END ";s='REPLACE INTO __currents_ids__ VALUES( null, "'+t+'", 1 )';e._transaction({query:[this._createTableQuery,i,s],internalContext:this,internalCallback:this._updateSchema10,isInternal:true})},_updateSchema:function(){var e=this._ORM,t=this._createTableQuery,n=this._name,r=n+ +(new Date),i=t.replace('CREATE TABLE "'+n+'"','CREATE TABLE "'+r+'"');this._offset=0;this._tempSchemaName=r;if(this.devMode){console.log('    1) Creating the "'+r+'" table (this will be the new one at the end of the process)')}e._transaction({query:i,internalContext:this,internalCallback:this._updateSchema2,isInternal:true})},_updateSchema2:function(){var e=this._ORM,t=e._name,n=this._name,r=this._tempSchemaName,i=[],s=this._indexesToCreate,o;if(this.devMode){console.log("   2) Creating again the indexes (if there is any one)")}for(o in s){i.push("DROP INDEX IF EXISTS "+this._getIndexName(n,o));if(s[o]){i.push(this._getIndexUniqueQuery(n,o,r))}else{i.push(this._getIndexQuery(n,o,r))}}if(i.length){e._transaction({query:i,internalContext:this,internalCallback:this._updateSchema3,isInternal:true})}else{this._updateSchema3()}},_updateSchema3:function(){var e=this._ORM,t=this._name,n=this._tempSchemaName,r=this._offset,i;if(this._isForceEmpty){if(this.devMode){console.log('   "forceEmpty" flag detected, the records will no be saved!')}this._isEmpty=true;this._updateSchema8()}else if(this._isForceDestroy){this._updateSchema7()}else{this._updateSchema4()}},_updateSchema4:function(){var e=this._ORM,t=this._name,n=this._tempSchemaName,r="SELECT * FROM "+t+" LIMIT "+this._offset+", 500";if(this.devMode){console.log('    2) Fetching all rows from old schema "'+t+'" by 500 rows per time')}e._transaction({query:r,internalContext:this,internalCallback:this._updateSchema5,isInternal:true})},_updateSchema5:function(e){var t=this._ORM,n=this._schemaFields,r=this._name,i=this._tempSchemaName,s=e.rows,o,u,a,f=[],l,c=[],h=[],p=[],d=[],v,m,g,y;if(!s.length){if(this.devMode){console.log('   3) Old schema "'+r+'" '+(this._offset===0?"has no records on it":"has no more records to be saved")+", moving to next step")}this._updateSchema6()}else{o=s.item(0);for(u in o){if(n[u]){f.push(u)}}for(u in n){a=n[u];if(f.indexOf(u)===-1){f.push(u);h.push(a.zero);c.push("?")}}for(m=0,g=s.length;m<g;m++){v=[];l=[];o=s.item(m);for(u in o){a=n[u];if(a){l.push("?");if(a.isJSON){v.push(o[u])}else{v.push(a.sanitizer(o[u],a.zero))}}}p.push("INSERT INTO "+i+" ( "+f.join(", ")+" ) VALUES ( "+l.concat(c).join(", ")+" )");d.push(v.concat(h))}if(this.devMode){console.log('   3) Inserting rows from old schema "'+r+'" into the new schema "'+i+'" (rows may fail if they violated any constraints)')}y={query:p,replacements:d,internalContext:this,isInternal:true};if(g===500){this._offset+=500;y.internalCallback=this._updateSchema4}else{y.internalCallback=this._updateSchema6}t._transaction(y)}},_updateSchema6:function(){var e=this._ORM,t=this._name,n="DROP TABLE "+t,r=this._tempSchemaName,i="ALTER TABLE "+r+" RENAME TO "+t;if(this.devMode){console.log('   4) Deleting old schema "'+t+'" (any index left will be dropped aswell)');console.log('    5) Renaming new schema "'+r+'" to "'+t+'"')}e._transaction({query:[n,i],internalContext:this,internalCallback:this._updateSchema7,isInternal:true})},_updateSchema7:function(){var e=this._ORM;if(this.devMode){console.log("   7) Initialization schema process has ended successful")}if(this._isForceEmpty&&!this._isEmpty){this._updateSchema9()}else{this._updateSchema8()}},_updateSchema8:function(){delete this._createTableQuery;delete this._indexesToCreate;delete this._isEmpty;delete this._tempSchemaName;delete this._offset;delete this._indexesToDelete;delete this._isForceDestroy;delete this._isForceEmpty;this._initCallback.call(this._initContext,true);delete this._initCallback;delete this._initContext;this._ORM._initSchemas()},_updateSchema9:function(){var e=this._ORM,t=e._name,n=this._name,r='--MSQTA-ORM: "forceEmpty" flag detected: emptying the "'+n+'" schema from the "'+t+'" database--\n  DELETE FROM '+n;e._transaction({query:[r],internalContext:this,internalCallback:this._updateSchema8,isInternal:true})},_updateSchema10:function(){var e=this._ORM,t=this._name,n=[],r=this._indexesToDelete,i=this._indexesToCreate,s;if(this.devMode){console.log("    2) Creating/removing index(s) (if there is any)")}while(r.length){n.push("DROP INDEX "+this._getIndexName(t,r.shift()))}for(s in i){if(i[s]){n.push(this._getIndexUniqueQuery(t,s))}else{n.push(this._getIndexQuery(t,s))}}if(n.length){e._transaction({query:n,internalContext:this,internalCallback:this._updateSchema7,isInternal:true})}else{this._updateSchema7()}},get:function(e,t,n){var r=this._ORM,i=this._schemaFields,s,o=r._name,u=this._name,a,f=[],l=[];if(!e){MSQTA._Errors.get(o,u)}for(s in i){f.push(s+" = ?");l.push(this._getValueBySchema(s,e))}a="SELECT * FROM "+u+" WHERE "+f.join(" OR ");r._transaction({query:a,replacements:[l],internalCallback:this._processResults,internalContext:this,userCallback:t,userContext:n})},getByCallback:function(e,t,n){var r=this._ORM,i=this._schemaFields,s,o=this._name,u;if(typeof e!=="function"){MSQTA._Errors.getByCallback(databaseName,o)}u="SELECT * FROM "+o;r._transaction({query:u,internalContext:this,internalCallback:this._getByCallback,userCallback:t,userContext:n,filterCallback:e})},_getByCallback:function(e,t){var n=this._schemaFields,r=e.rows,i=0,s=r.length,o,u,a=t.filterCallback,f,l=[];for(;i<s;i++){o=r.item(i);f={};for(u in o){f[u]=n[u].toJS(o[u])}if(a(f)){l.push(f)}}t.userCallback.call(t.userContext,l)},getByIndex:function(e,t,n,r){var i=this._ORM,s=i._name,o=this._name,u,a=[],f=[],l,c,h,p;if(this._primaryKey!==e){if(this._indexes.indexOf(e)===-1){MSQTA._Errors.getByIndex1(s,o,e)}}if(!t){MSQTA._Errors.getByIndex2(s,o)}if(!Array.isArray(t)){t=[t]}for(h=0,p=t.length;h<p;h++){l=t[h];c=this._getValueBySchema(e,l);a.push(e+" = ?");f.push(c)}u="SELECT * FROM "+o+(a.length?" WHERE "+a.join(" OR "):"");i._transaction({query:u,replacements:[f],internalContext:this,internalCallback:this._processResults,userCallback:n,userContext:r})},getByIndexWithRange:function(e,t,n,r){var i=this._ORM,s=i._name,o=this._name,u=this._schemaFields,a=/^(?:>|<|>=|<=|=)$/,f,l=[],c,h,p=[],d;if(this._primaryKey!==e){if(this._indexes.indexOf(e)===-1){MSQTA._Errors.getByIndexWithRange1(s,o,e)}}for(f in t){if(!a.test(f)){MSQTA._Errors.getByIndexWithRange2(f)}c=t[f];h=this._getValueBySchema(e,c);if(!h&&h!==u[e].zero){MSQTA._Errors.getByIndexWithRange3(s,o,c,h)}l.push(e+" "+f+" ?");p.push(h)}if(!l.length){MSQTA._Errors.getByIndexWithRange4()}d="SELECT * FROM "+o+" WHERE "+l.join(" AND ");i._transaction({query:d,replacements:[p],internalContext:this,internalCallback:this._processResults,userCallback:n,userContext:r})},getAll:function(e,t){var n=this._ORM,r=this._name,i="SELECT * FROM "+r;n._transaction({query:i,internalContext:this,internalCallback:this._processResults,userCallback:e,userContext:t})},getWithLike:function(e,t,n,r){var i=this._ORM,s=i._name,o=this._schemaFields,u=this._name,a,f,l,c,h,p=[],d,v=[];if(typeof t!=="object"){MSQTA._Errors.getWithLike1()}c=Object.keys(t)[0];h=t[c];if(!c||!h){MSQTA._Errors.getWithLike1()}if(c==="both"){h="%"+h+"%"}else if(c==="start"){h=h+"%"}else if(c==="end"){h="%"+h}if(!Array.isArray(e)){e=[e]}for(a=0,f=e.length;a<f;a++){l=e[a];if(!o[l]){MSQTA._Errors.getWithLike2(s,u,l)}v.push(l+" LIKE ?");p.push(h)}d="SELECT * FROM "+u+" WHERE "+v.join(" OR ");i._transaction({query:d,replacements:[p],internalContext:this,internalCallback:this._processResults,userCallback:n,userContext:r})},_processResults:function(e,t){var n=this._schemaFields,r=e.rows,i=0,s=r.length,o,u,a,f=[];for(;i<s;i++){o=r.item(i);a={};for(u in o){a[u]=n[u].toJS(o[u])}f.push(a)}t.userCallback.call(t.userContext,f)},put:function(e,t,n){var r=this._ORM,i=r._name,s=this._fieldsName,o,u,a=this._name,f=this._primaryKey,l,c=[],h,p,d=[],v,m,g,y;if(!Array.isArray(e)&&typeof e==="object"){e=[e]}for(m=0,g=e.length;m<g;m++){v=e[m];l=[];h=[];p=[];for(o in v){if(s.indexOf(o)===-1){MSQTA._Errors.put1(i,a,o)}l.push(o);u=this._getValueBySchema(o,v[o]);if(o===f&&(!u||u<=0)){p.push('( SELECT last_id FROM __currents_ids__ WHERE table_name = "'+a+'" )')}else{h.push(u);p.push("?")}}c.push(h);d.push("INSERT OR ROLLBACK INTO "+a+" ( "+l.join(", ")+" ) "+"VALUES ( "+p.join(" , ")+" )")}y={query:d,replacements:c,userCallback:t,userContext:n,isInsert:true};if(r._isBatchMode){return y}r._transaction(y)},set:function(e,t,n){var r=this._ORM,i=this._name,s=r._name,o=this._schemaFields,u,a,f,l,c,h,p,d,v,m=[],g,y=[],b,w,E;if(!e||typeof e!=="object"){MSQTA._Errors.set1(s,i,e)}if(!Array.isArray(e)){e=[e]}for(b=0,w=e.length;b<w;b++){a=e[b];g=[];v=[];d=[];if(!a.data||typeof a.data!=="object"||!Object.keys(a.data).length){MSQTA._Errors.set2(s,i,a.data)}if(a.target){if(typeof a.target!=="object"||!Object.keys(a.target).length){MSQTA._Errors.set3(s,i,a.target)}}else{a.target=[]}c=a.data;for(h in c){p=c[h];f=this._getValueBySchema(h,p);if(!f&&f!==o[h].zero){MSQTA._Errors.set5(s,i,h,p,f)}v.push(h+" = ?");g.push(f)}l=a.target;for(h in l){p=l[h];f=this._getValueBySchema(h,p);if(!f&&f!==o[h].zero){MSQTA._Errors.set4(s,i,h,p,f)}d.push(h+" = ?");g.push(f)}y.push("UPDATE OR ROLLBACK "+i+" SET "+v.join(", ")+(d.length?" WHERE "+d.join(" AND "):""));m.push(g)}E={query:y,replacements:m,isUpdate:true,userCallback:t,userContext:n};if(r._isBatchMode){return E}r._transaction(E)},del:function(e,t,n){var r=this._ORM,i=r._name,s=this._primaryKey,o=this._name,u,a,f,l=[],c,h,p;if(!s){MSQTA._Errors.del1(i,o)}if(!e){MSQTA._Errors.del2(i,o)}if(!Array.isArray(e)){e=[e]}for(c=0,h=e.length;c<h;c++){u=e[c];a=this._getValueBySchema(s,u);if(!a){MSQTA._Errors.del3(i,o,u,a)}l.push(s+" = "+a)}f="DELETE FROM "+o+(l.length?" WHERE "+l.join(" OR "):"");p={query:f,isDelete:true,userCallback:t,userContext:n};if(r._isBatchMode){return p}r._transaction(p)},destroy:function(e,t){var n=this._ORM,r=this._name,i="DROP TABLE "+r;n._transaction({internalCallback:this._destroy,internalContext:this,query:i,userCallback:e,userContext:t})},_destroy:function(e,t){var n=this._ORM;if(e){n._deleteUserSchema(this,t)}},empty:function(e,t){var n=this._ORM,r=this._name,i="DELETE FROM "+r;n._transaction({query:i,isDelete:true,userCallback:e,userContext:t})}}
